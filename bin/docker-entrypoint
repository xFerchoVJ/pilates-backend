#!/bin/bash
set -e

# Carga variables de entorno desde .env si existe
if [ -f /app/.env ]; then
  export $(grep -v '^#' /app/.env | xargs)
fi

# ConfiguraciÃ³n por defecto de Postgres si no estÃ¡n en .env
DB_HOST=${POSTGRES_HOST:-db}
DB_PORT=${POSTGRES_PORT:-5432}
DB_USER=${POSTGRES_USER:-postgres}

# Elimina pid del servidor Rails si existe
rm -f /app/tmp/pids/server.pid

# --- Esperar a Postgres ---
echo "â³ Esperando que la base de datos estÃ© lista..."
until pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER; do
  echo "â³ Base de datos no estÃ¡ lista - esperando..."
  sleep 2
done
echo "âœ… Base de datos lista!"

# --- Ejecutar migraciones ---
echo "ðŸ—„ï¸ Ejecutando migraciones..."
bundle exec rails db:migrate 2>/dev/null || bundle exec rails db:create db:migrate

# --- Arrancar Rails por defecto si no hay comandos ---
if [ "$IS_LOCAL" = "false" ]; then
  PORT=${PORT:-3000} # Railway usa $PORT
  echo "ðŸš€ Arrancando servidor Rails por defecto en el puerto $PORT..."
  exec bundle exec rails server -b 0.0.0.0 -p $PORT
else
  # Ejecuta cualquier comando que se pase al contenedor
  exec "$@"
fi
